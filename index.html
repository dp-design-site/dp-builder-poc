<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DP Configurator Builder – MVP</title>
  <!-- Interact.js за drag & resize -->
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <style>
    :root{
      --bg: #0f1115;
      --panel: #161a22;
      --panel-2: #1d2330;
      --text: #e8ecf2;
      --muted: #a8b0c2;
      --accent: #3ea6ff;
      --grid: rgba(255,255,255,0.06);
      --danger: #ff5d5d;
      --ok: #42d392;
      --guide: #66ccffaa;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
      user-select:none;
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px; background:var(--panel); border-bottom:1px solid #222839;
      position:sticky; top:0; z-index:10;
      gap:10px; flex-wrap:wrap;
    }
    .brand{ font-weight:700; letter-spacing:.3px; }
    .actions, .alignbar{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn, .file span{
      background:var(--panel-2); color:var(--text);
      border:1px solid #283149; padding:8px 10px; border-radius:10px; cursor:pointer;
    }
    .btn.danger{ background:#2a1820; border-color:#5c2332; color:#ffb3b3; }

    .layout{ display:grid; grid-template-columns: 240px 1fr 300px; height: calc(100vh - 58px); }
    .sidebar{ background:var(--panel); border-right:1px solid #222839; overflow:auto; }
    .sidebar.right{ border-right:none; border-left:1px solid #222839; }
    .sidebar h2{ margin:12px 12px 8px; font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:.8px; }
    .hint{ color:var(--muted); margin:8px 12px 12px; }

    .palette{ display:grid; grid-template-columns:1fr; gap:8px; padding:0 12px 16px; }
    .palette-item{
      padding:10px 12px; border-radius:10px; background:var(--panel-2);
      border:1px dashed #3a425e; cursor:grab; user-select:none; text-align:center;
    }
    .palette-item:active{ cursor:grabbing; }

    .toolbar{ display:flex; gap:8px; padding:8px 12px; border-top:1px solid #222839; }

    .canvas{
      position:relative; background:
        linear-gradient(transparent 24px, var(--grid) 25px),
        linear-gradient(90deg, transparent 24px, var(--grid) 25px);
      background-size:25px 25px;
      overflow:auto;
    }
    .canvas-hint{
      position:absolute; left:50%; top:30%; transform:translate(-50%,-50%);
      color:var(--muted);
    }

    .widget{
      position:absolute; display:flex; align-items:center; justify-content:center;
      padding:8px 10px; border-radius:12px; cursor:move;
      min-width:60px; min-height:36px; border:1px solid #39425e; background:#1b2232;
    }
    .widget.selected{ outline:2px solid var(--accent); outline-offset:2px; }
    .widget button{
      all:unset; padding:8px 12px; border-radius:10px; text-align:center; cursor:pointer;
      border:1px solid #2a3350; background:#20273a; min-width:76px;
    }
    .widget.label{ background:transparent; border:1px dashed #2a3350; color:#cfd7e6; }
    .widget.panel{ background:#121722; border:1px solid #2a2f44; }
    .widget .toggle{
      display:inline-block; padding:8px 12px; border-radius:999px; border:1px solid #2a3350; background:#20273a;
    }
    .variant-primary{ background:#1b3b5a; border-color:#275985; }
    .variant-secondary{ background:#2b2f3f; border-color:#3c445e; }
    .variant-ghost{ background:transparent; border-color:#3c445e; }
    .variant-danger{ background:#3a1f2a; border-color:#8b2a3b; color:#ffb3b3; }

    /* Критично: да не блокира drag/resize */
    .widget *{ pointer-events:none; }

    .inspector{ padding:12px; }
    .inspector .empty{ color:var(--muted); }
    .inspector .fields.hidden{ display:none; }
    .inspector .row{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .inspector .row.two{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .inspector input, .inspector select, .inspector button{
      background:var(--panel-2); color:var(--text);
      border:1px solid #2b3550; border-radius:10px; padding:8px 10px;
    }

    /* Smart guides */
    .guide{ position:absolute; background:var(--guide); z-index:5; pointer-events:none; }
    .guide.v{ width:1px; top:0; bottom:0; }
    .guide.h{ height:1px; left:0; right:0; }

    /* Маркиране за множествена селекция */
    .marquee{ position:absolute; border:1px dashed var(--accent); background:rgba(62,166,255,0.08); pointer-events:none; z-index:8; }

    .foot{ padding:8px 14px; color:var(--muted); border-top:1px solid #222839; background:var(--panel); }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">DP Configurator Builder · MVP</div>
    <div class="actions">
      <button id="btn-export" class="btn">Export JSON</button>
      <label class="file btn"><input id="file-import" type="file" accept="application/json" hidden /><span>Import JSON</span></label>
      <button id="btn-clear" class="btn">Clear</button>
      <button id="btn-save" class="btn">Save (Local)</button>
      <button id="btn-load" class="btn">Load (Local)</button>
    </div>
    <div class="alignbar">
      <button class="btn" id="align-left">Align Left</button>
      <button class="btn" id="align-right">Align Right</button>
      <button class="btn" id="align-top">Align Top</button>
      <button class="btn" id="align-bottom">Align Bottom</button>
      <button class="btn" id="align-vcenter">V Center</button>
      <button class="btn" id="align-hcenter">H Center</button>
      <button class="btn" id="distribute-h">Distribute H</button>
      <button class="btn" id="distribute-v">Distribute V</button>
    </div>
  </header>

  <main class="layout">
    <aside class="sidebar left">
      <h2>Библиотека</h2>
      <div class="palette">
        <div class="palette-item" data-type="button">Button</div>
        <div class="palette-item" data-type="toggle">Toggle</div>
        <div class="palette-item" data-type="label">Label</div>
        <div class="palette-item" data-type="panel">Panel</div>
      </div>
      <p class="hint">Drag & drop върху платното</p>
    </aside>

    <section id="canvas" class="canvas" aria-label="Workspace (Canvas)">
      <div class="canvas-hint">Пусни елементи тук</div>
      <!-- smart guides container -->
      <div id="guide-v" class="guide v" style="display:none"></div>
      <div id="guide-h" class="guide h" style="display:none"></div>
      <div id="marquee" class="marquee" style="display:none"></div>
    </section>

    <aside class="sidebar right">
      <h2>Свойства</h2>
      <form id="inspector" class="inspector" autocomplete="off">
        <div class="empty">Няма избран елемент</div>
        <div class="fields hidden">
          <div class="row"><label>ID</label><input type="text" id="prop-id" readonly /></div>
          <div class="row"><label>Тип</label><input type="text" id="prop-type" readonly /></div>
          <div class="row"><label>Текст</label><input type="text" id="prop-text" placeholder="Надпис" /></div>
          <div class="row two">
            <div><label>X</label><input type="number" id="prop-x" /></div>
            <div><label>Y</label><input type="number" id="prop-y" /></div>
          </div>
          <div class="row two">
            <div><label>Ширина</label><input type="number" id="prop-w" /></div>
            <div><label>Височина</label><input type="number" id="prop-h" /></div>
          </div>
          <div class="row"><label>Размер шрифт</label><input type="number" id="prop-font" min="8" max="64" /></div>
          <div class="row" id="row-variant">
            <label>Вариант</label>
            <select id="prop-variant">
              <option value="primary">Primary</option>
              <option value="secondary">Secondary</option>
              <option value="ghost">Ghost</option>
              <option value="danger">Danger</option>
            </select>
          </div>
          <div class="row"><button type="button" id="prop-delete" class="btn danger">Изтрий елемента</button></div>
        </div>
      </form>
    </aside>
  </main>

  <footer class="foot">
    <small>Drag: задържи и мести · Resize: дръпни от ъглите · Snap: 10px · Smart guides · Multi‑select (Shift+Click / влачене с мишката) · Duplicate: Ctrl+D</small>
  </footer>

<script>
(() => {
  // ======= Утилити =======
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const uid = () => 'w_' + Math.random().toString(36).slice(2,9);
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  const GRID = 10; // snap 10px
  const SNAP_TOL = 6; // пиксели за smart guide

  // ======= Състояние =======
  const state = {
    selection: new Set(),
    dragStartPositions: new Map(), // id -> {x, y}
    lastMouseDownOnCanvas: 0
  };

  function setSelection(ids){
    state.selection = new Set(ids || []);
    $$('.widget').forEach(w => w.classList.toggle('selected', state.selection.has(w.dataset.id)));
    if(state.selection.size === 1){ fillInspector(getSelected()); } else { showEmptyInspector(); }
  }
  function addToSelection(id){ state.selection.add(id); $(`.widget[data-id="${id}"]`).classList.add('selected'); if(state.selection.size===1) fillInspector(getSelected()); }
  function removeFromSelection(id){ state.selection.delete(id); $(`.widget[data-id="${id}"]`)?.classList.remove('selected'); if(state.selection.size!==1) showEmptyInspector(); }
  function getSelected(){ if(state.selection.size!==1) return null; const id=[...state.selection][0]; return $(`.widget[data-id="${id}"]`); }

  // ======= Създаване на widget DOM =======
  function createWidget(type, x=40, y=40){
    const id = uid();
    const el = document.createElement('div');
    el.className = `widget ${type}`;
    el.dataset.id = id; el.dataset.type = type;
    el.style.left = x + 'px'; el.style.top = y + 'px';

    if(type === 'button'){
      const b = document.createElement('button');
      b.textContent = 'Button'; b.className = 'variant-primary';
      el.appendChild(b);
    } else if(type === 'toggle'){
      const t = document.createElement('div'); t.className = 'toggle'; t.textContent = 'Toggle'; el.appendChild(t);
    } else if(type === 'label'){
      el.textContent = 'Label'; el.style.padding = '6px 10px';
    } else if(type === 'panel'){
      el.style.width = '220px'; el.style.height = '140px';
    }

    $('#canvas').appendChild(el);
    applyInteract(el);
    setSelection([id]);
    return el;
  }

  // ======= Interact.js: drag + resize (+ групово преместване) =======
  function applyInteract(el){
    interact(el).draggable({
      listeners: {
        start (event){
          // запис на стартови позиции на всички селектирани
          const ids = state.selection.has(el.dataset.id) ? [...state.selection] : [el.dataset.id];
          state.dragStartPositions.clear();
          for(const id of ids){
            const w = $(`.widget[data-id="${id}"]`);
            state.dragStartPositions.set(id, { x: parseInt(w.style.left||'0',10), y: parseInt(w.style.top||'0',10) });
          }
          // водачи off
          hideGuides();
        },
        move (event) {
          const ids = state.selection.has(el.dataset.id) ? [...state.selection] : [el.dataset.id];
          const dx = event.dx, dy = event.dy;

          // първо изчисляваме новата позиция за водещия елемент (el)
          const start = state.dragStartPositions.get(el.dataset.id);
          let nx = start.x + dx;
          let ny = start.y + dy;

          // snap към grid
          nx = Math.round(nx / GRID) * GRID;
          ny = Math.round(ny / GRID) * GRID;

          // smart guides – съпоставяне към други ръбове/центрове
          const snapped = applySmartGuides(el, nx, ny);
          nx = snapped.x; ny = snapped.y;

          // премести всички селектирани със същото отместване спрямо началната им позиция
          for(const id of ids){
            const w = $(`.widget[data-id="${id}"]`);
            const s = state.dragStartPositions.get(id);
            let wx = s.x + (nx - start.x);
            let wy = s.y + (ny - start.y);
            w.style.left = Math.round(wx) + 'px';
            w.style.top  = Math.round(wy) + 'px';
          }

          if(state.selection.size===1) updateInspectorPosition(nx, ny);
        },
        end(){ hideGuides(); }
      }, inertia:false
    });

    interact(el).resizable({
      edges: { left:true, right:true, bottom:true, top:true }, inertia:false,
      listeners: {
        move (event){
          const target = event.target;
          const startX = parseInt(target.style.left||'0',10);
          const startY = parseInt(target.style.top ||'0',10);

          let w = event.rect.width, h = event.rect.height;
          w = Math.max(40, Math.round(w/GRID)*GRID);
          h = Math.max(30, Math.round(h/GRID)*GRID);
          target.style.width  = w + 'px';
          target.style.height = h + 'px';

          // когато се ресайзва от ляво/горе – местим L/T
          const nx = Math.round((startX + event.deltaRect.left)/GRID)*GRID;
          const ny = Math.round((startY + event.deltaRect.top )/GRID)*GRID;
          target.style.left = nx + 'px';
          target.style.top  = ny + 'px';

          $('#prop-w').value = Math.round(w);
          $('#prop-h').value = Math.round(h);
          updateInspectorPosition(nx, ny);
        }
      }
    });

    // селекция с click / shift+click
    el.addEventListener('pointerdown', (e)=>{
      e.stopPropagation();
      if(e.shiftKey){
        if(state.selection.has(el.dataset.id)) removeFromSelection(el.dataset.id);
        else addToSelection(el.dataset.id);
      } else {
        setSelection([el.dataset.id]);
      }
    });
  }

  // ======= Smart Guides =======
  function hideGuides(){ $('#guide-v').style.display='none'; $('#guide-h').style.display='none'; }
  function applySmartGuides(el, nx, ny){
    const others = $$('.widget').filter(w => w!==el);
    const r = getRect(el, nx, ny);

    let snapX = nx, snapY = ny;
    let showV = false, showH = false, vPos = 0, hPos = 0;

    // сравняваме лев/център/десен към други елементи
    for(const o of others){
      const or = getRect(o);
      // вертикални
      const xs = [or.left, or.centerX, or.right];
      for(const x of xs){
        if(Math.abs(r.left - x) <= SNAP_TOL){ snapX += (x - r.left); vPos = x; showV = true; }
        if(Math.abs(r.centerX - x) <= SNAP_TOL){ snapX += (x - r.centerX); vPos = x; showV = true; }
        if(Math.abs(r.right - x) <= SNAP_TOL){ snapX += (x - r.right); vPos = x; showV = true; }
      }
      // хоризонтални
      const ys = [or.top, or.centerY, or.bottom];
      for(const y of ys){
        if(Math.abs(r.top - y) <= SNAP_TOL){ snapY += (y - r.top); hPos = y; showH = true; }
        if(Math.abs(r.centerY - y) <= SNAP_TOL){ snapY += (y - r.centerY); hPos = y; showH = true; }
        if(Math.abs(r.bottom - y) <= SNAP_TOL){ snapY += (y - r.bottom); hPos = y; showH = true; }
      }
    }

    // показване на водачите
    const gv = $('#guide-v'), gh = $('#guide-h');
    if(showV){ gv.style.left = vPos + 'px'; gv.style.display='block'; } else gv.style.display='none';
    if(showH){ gh.style.top  = hPos + 'px'; gh.style.display='block'; } else gh.style.display='none';

    return { x: snapX, y: snapY };
  }

  function getRect(el, left=null, top=null){
    const x = left ?? parseInt(el.style.left||'0',10);
    const y = top  ?? parseInt(el.style.top ||'0',10);
    const w = el.offsetWidth; const h = el.offsetHeight;
    return { left:x, top:y, right:x+w, bottom:y+h, centerX:x+w/2, centerY:y+h/2, w, h };
  }

  // ======= Palette drag & drop (клик или drop) =======
  let ghostType = null;
  $$('.palette-item').forEach(it => {
    it.addEventListener('dragstart', ()=>{ ghostType = it.dataset.type; });
    it.addEventListener('click', ()=> createWidget(it.dataset.type, 40 + Math.random()*60, 40 + Math.random()*60));
  });
  $('#canvas').addEventListener('dragover', e=> e.preventDefault());
  $('#canvas').addEventListener('drop', e=>{
    e.preventDefault(); if(!ghostType) return;
    const rect = $('#canvas').getBoundingClientRect();
    const x = Math.round((e.clientX - rect.left) / GRID) * GRID;
    const y = Math.round((e.clientY - rect.top ) / GRID) * GRID;
    createWidget(ghostType, x, y); ghostType = null;
  });

  // ======= Маркиране (marquee) за множествена селекция =======
  const marquee = $('#marquee');
  let marqueeStart = null;
  $('#canvas').addEventListener('pointerdown', (e)=>{
    if(e.target !== $('#canvas')) return; // само върху празно
    marqueeStart = { x: e.offsetX, y: e.offsetY };
    marquee.style.left = marqueeStart.x + 'px';
    marquee.style.top  = marqueeStart.y + 'px';
    marquee.style.width = '0px';
    marquee.style.height= '0px';
    marquee.style.display='block';
  });
  $('#canvas').addEventListener('pointermove', (e)=>{
    if(!marqueeStart) return;
    const x = e.offsetX, y = e.offsetY;
    const l = Math.min(x, marqueeStart.x), t = Math.min(y, marqueeStart.y);
    const w = Math.abs(x - marqueeStart.x), h = Math.abs(y - marqueeStart.y);
    marquee.style.left = l + 'px'; marquee.style.top = t + 'px';
    marquee.style.width = w + 'px'; marquee.style.height = h + 'px';
  });
  window.addEventListener('pointerup', ()=>{
    if(!marqueeStart) return;
    const mr = marquee.getBoundingClientRect();
    const cr = $('#canvas').getBoundingClientRect();
    const ml = mr.left - cr.left, mt = mr.top - cr.top, mrgt = ml + mr.width, mb = mt + mr.height;
    const ids = $$('.widget').filter(w=>{
      const r = getRect(w);
      return !(r.right < ml || r.left > mrgt || r.bottom < mt || r.top > mb);
    }).map(w=>w.dataset.id);
    setSelection(ids);
    marqueeStart = null; marquee.style.display='none';
  });

  // ======= Инспектор =======
  function showEmptyInspector(){ $('#inspector .empty').style.display=''; $('#inspector .fields').classList.add('hidden'); }
  function fillInspector(el){
    if(!el){ showEmptyInspector(); return; }
    $('#inspector .empty').style.display='none';
    $('#inspector .fields').classList.remove('hidden');

    const left = parseInt(el.style.left||'0',10);
    const top  = parseInt(el.style.top ||'0',10);
    $('#prop-id').value = el.dataset.id;
    $('#prop-type').value = el.dataset.type;
    $('#prop-x').value = Math.round(left);
    $('#prop-y').value = Math.round(top);
    $('#prop-w').value = Math.round(el.offsetWidth);
    $('#prop-h').value = Math.round(el.offsetHeight);

    const isButton = el.dataset.type === 'button';
    $('#row-variant').style.display = isButton ? '' : 'none';

    let contentText = (isButton ? el.querySelector('button').textContent : (el.dataset.type==='toggle' ? el.querySelector('.toggle').textContent : el.textContent));
    $('#prop-text').value = contentText;

    const targetForFont = (isButton ? el.querySelector('button') : (el.dataset.type === 'toggle' ? el.querySelector('.toggle') : el));
    const computedFont = parseInt(getComputedStyle(targetForFont).fontSize,10);
    $('#prop-font').value = isNaN(computedFont) ? 14 : computedFont;

    if(isButton){
      const cls = (targetForFont.className||'');
      let v='primary'; if(cls.includes('variant-secondary')) v='secondary'; else if(cls.includes('variant-ghost')) v='ghost'; else if(cls.includes('variant-danger')) v='danger';
      $('#prop-variant').value = v;
    }
  }
  function updateInspectorPosition(x,y){ if(state.selection.size===1){ $('#prop-x').value=Math.round(x); $('#prop-y').value=Math.round(y); } }

  $('#prop-text').addEventListener('input', e=>{
    const el = getSelected(); if(!el) return;
    if(el.dataset.type==='button') el.querySelector('button').textContent = e.target.value || 'Button';
    else if(el.dataset.type==='toggle') el.querySelector('.toggle').textContent = e.target.value || 'Toggle';
    else el.textContent = e.target.value || 'Label';
  });
  $('#prop-x').addEventListener('change', e=>{ const el=getSelected(); if(!el) return; const x=Math.round(parseInt(e.target.value||0,10)/GRID)*GRID; el.style.left=x+'px'; });
  $('#prop-y').addEventListener('change', e=>{ const el=getSelected(); if(!el) return; const y=Math.round(parseInt(e.target.value||0,10)/GRID)*GRID; el.style.top=y+'px'; });
  $('#prop-w').addEventListener('change', e=>{ const el=getSelected(); if(!el) return; const w=Math.max(40, Math.round(parseInt(e.target.value||0,10)/GRID)*GRID); el.style.width=w+'px'; });
  $('#prop-h').addEventListener('change', e=>{ const el=getSelected(); if(!el) return; const h=Math.max(30, Math.round(parseInt(e.target.value||0,10)/GRID)*GRID); el.style.height=h+'px'; });
  $('#prop-font').addEventListener('change', e=>{
    const el=getSelected(); if(!el) return; const target = el.dataset.type==='button'?el.querySelector('button'): el.dataset.type==='toggle'?el.querySelector('.toggle'):el; target.style.fontSize = clamp(parseInt(e.target.value||14,10),8,64)+'px';
  });
  $('#prop-variant').addEventListener('change', e=>{ const el=getSelected(); if(!el||el.dataset.type!=='button') return; const b=el.querySelector('button'); b.className=''; b.classList.add('variant-'+e.target.value); });
  $('#prop-delete').addEventListener('click', ()=>{ for(const id of [...state.selection]) { $(`.widget[data-id="${id}"]`).remove(); } setSelection([]); });

  // ======= Export / Import / Local save =======
  function serialize(){
    const items = $$('.widget').map(el=>{
      const type = el.dataset.type; const x=parseInt(el.style.left||'0',10); const y=parseInt(el.style.top||'0',10);
      const w=Math.round(el.offsetWidth), h=Math.round(el.offsetHeight);
      let text='', fontSize=14, variant=null;
      if(type==='button'){ const b=el.querySelector('button'); text=b.textContent; fontSize=parseInt(getComputedStyle(b).fontSize,10); const cls=b.className||''; variant=cls.includes('variant-secondary')?'secondary':cls.includes('variant-ghost')?'ghost':cls.includes('variant-danger')?'danger':'primary'; }
      else if(type==='toggle'){ const t=el.querySelector('.toggle'); text=t.textContent; fontSize=parseInt(getComputedStyle(t).fontSize,10); }
      else { text=el.textContent; fontSize=parseInt(getComputedStyle(el).fontSize,10); }
      return { id:el.dataset.id, type, x, y, w, h, text, fontSize, variant };
    });
    return { version:1, items };
  }
  function deserialize(data){ $('#canvas').innerHTML = '<div class="canvas-hint">Пусни елементи тук</div><div id="guide-v" class="guide v" style="display:none"></div><div id="guide-h" class="guide h" style="display:none"></div><div id="marquee" class="marquee" style="display:none"></div>';
    data.items.forEach(it=>{ const el=createWidget(it.type, it.x, it.y); el.style.width=it.w+'px'; el.style.height=it.h+'px'; if(it.type==='button'){ const b=el.querySelector('button'); b.textContent=it.text||'Button'; b.style.fontSize=(it.fontSize||14)+'px'; b.className='variant-'+(it.variant||'primary'); } else if(it.type==='toggle'){ const t=el.querySelector('.toggle'); t.textContent=it.text||'Toggle'; t.style.fontSize=(it.fontSize||14)+'px'; } else { el.textContent=it.text||(it.type==='label'?'Label':''); el.style.fontSize=(it.fontSize||14)+'px'; } }); setSelection([]); }

  $('#btn-export').addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(serialize(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dp-configurator.json'; a.click(); URL.revokeObjectURL(a.href); });
  $('#file-import').addEventListener('change', async (e)=>{ const file=e.target.files?.[0]; if(!file) return; try{ deserialize(JSON.parse(await file.text())); }catch{ alert('Invalid JSON'); } e.target.value=''; });
  $('#btn-clear').addEventListener('click', ()=>{ if(confirm('Да изчистя ли платното?')){ deserialize({version:1, items:[]}); }});
  $('#btn-save').addEventListener('click', ()=>{ localStorage.setItem('dp-configurator-mvp', JSON.stringify(serialize())); flash('Записано локално'); });
  $('#btn-load').addEventListener('click', ()=>{ const raw=localStorage.getItem('dp-configurator-mvp'); if(!raw){ alert('Няма локален запис'); return; } try{ deserialize(JSON.parse(raw)); flash('Заредено'); }catch{ alert('Повредени данни'); } });

  // ======= Duplicate (Ctrl+D) =======
  document.addEventListener('keydown', (e)=>{
    if(e.key==='Delete' || e.key==='Backspace'){ for(const id of [...state.selection]) { $(`.widget[data-id="${id}"]`)?.remove(); } setSelection([]); }
    if((e.ctrlKey||e.metaKey) && (e.key==='d' || e.key==='D')){
      e.preventDefault();
      const originals = [...state.selection].map(id => $(`.widget[data-id="${id}"]`));
      const clones = originals.map(o => ({
        type:o.dataset.type,
        x: parseInt(o.style.left||'0',10) + 20,
        y: parseInt(o.style.top ||'0',10) + 20,
        w: o.offsetWidth,
        h: o.offsetHeight,
        text: o.dataset.type==='button'?o.querySelector('button').textContent: o.dataset.type==='toggle'?o.querySelector('.toggle').textContent: o.textContent,
        font: parseInt(getComputedStyle(o.dataset.type==='button'?o.querySelector('button'):o.dataset.type==='toggle'?o.querySelector('.toggle'):o).fontSize,10),
        variant: o.dataset.type==='button' ? (o.querySelector('button').className.replace('variant-','')||'primary') : null
      }));
      const newIds = [];
      clones.forEach(c=>{ const el=createWidget(c.type, c.x, c.y); el.style.width=c.w+'px'; el.style.height=c.h+'px'; if(c.type==='button'){ const b=el.querySelector('button'); b.textContent=c.text; b.style.fontSize=(c.font||14)+'px'; b.className='variant-'+(c.variant||'primary'); } else if(c.type==='toggle'){ const t=el.querySelector('.toggle'); t.textContent=c.text; t.style.fontSize=(c.font||14)+'px'; } else { el.textContent=c.text; el.style.fontSize=(c.font||14)+'px'; } newIds.push(el.dataset.id); });
      setSelection(newIds);
    }
  });

  // ======= Подравняване и разпределяне =======
  function align(fn){ const sel=[...state.selection].map(id=>$(`.widget[data-id="${id}"]`)); if(sel.length<2) return; const rects=sel.map(getRect); fn(sel, rects); }
  $('#align-left').addEventListener('click', ()=> align((sel,rects)=>{ const L=Math.min(...rects.map(r=>r.left)); sel.forEach((w)=> w.style.left=L+'px'); }));
  $('#align-right').addEventListener('click', ()=> align((sel,rects)=>{ const R=Math.max(...rects.map(r=>r.right)); sel.forEach((w,i)=> w.style.left=(R - rects[i].w)+'px'); }));
  $('#align-top').addEventListener('click', ()=> align((sel,rects)=>{ const T=Math.min(...rects.map(r=>r.top)); sel.forEach((w)=> w.style.top=T+'px'); }));
  $('#align-bottom').addEventListener('click', ()=> align((sel,rects)=>{ const B=Math.max(...rects.map(r=>r.bottom)); sel.forEach((w,i)=> w.style.top=(B - rects[i].h)+'px'); }));
  $('#align-vcenter').addEventListener('click', ()=> align((sel,rects)=>{ const C=Math.round((Math.min(...rects.map(r=>r.top)) + Math.max(...rects.map(r=>r.bottom)))/2); sel.forEach((w,i)=> w.style.top=(C - Math.round(rects[i].h/2))+'px'); }));
  $('#align-hcenter').addEventListener('click', ()=> align((sel,rects)=>{ const C=Math.round((Math.min(...rects.map(r=>r.left)) + Math.max(...rects.map(r=>r.right)))/2); sel.forEach((w,i)=> w.style.left=(C - Math.round(rects[i].w/2))+'px'); }));
  $('#distribute-h').addEventListener('click', ()=> align((sel,rects)=>{ const sorted=rects.map((r,i)=>({r,i})).sort((a,b)=>a.r.left-b.r.left); const L=sorted[0].r.left, R=sorted.at(-1).r.right; const totalW=sorted.reduce((s,o)=>s+o.r.w,0); const gap=(R-L-totalW)/(sorted.length-1); let x=L; sorted.forEach(({r,i})=>{ sel[i].style.left=x+'px'; x+=r.w+gap; }); }));
  $('#distribute-v').addEventListener('click', ()=> align((sel,rects)=>{ const sorted=rects.map((r,i)=>({r,i})).sort((a,b)=>a.r.top-b.r.top); const T=sorted[0].r.top, B=sorted.at(-1).r.bottom; const totalH=sorted.reduce((s,o)=>s+o.r.h,0); const gap=(B-T-totalH)/(sorted.length-1); let y=T; sorted.forEach(({r,i})=>{ sel[i].style.top=y+'px'; y+=r.h+gap; }); }));

  // ======= Toast =======
  function flash(msg){ const t=document.createElement('div'); t.textContent=msg; Object.assign(t.style,{position:'fixed', right:'16px', bottom:'16px', background:'#1c2436', border:'1px solid #2b3550', color:'#e8ecf2', padding:'10px 12px', borderRadius:'10px', zIndex:9999}); document.body.appendChild(t); setTimeout(()=>t.remove(), 1600); }

  // ======= Инициализация: стартови елементи за демо =======
  createWidget('button', 80, 80);
  createWidget('button', 240, 80);
  createWidget('label', 80, 160);
})();
</script>
</body>
</html>
